name: API Integration Tests

# Run automated API tests using Newman (Postman CLI)
on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'app/api/**'
      - 'lib/**'
      - 'postman/**'
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: trading_alerts_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Next.js project exists
        id: check_project
        run: |
          if [ -d "app" ] || [ -d "pages" ] || [ -f "next.config.js" ] || [ -f "next.config.mjs" ]; then
            echo "project_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Next.js project found"
          else
            echo "project_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Next.js project not created yet (Phase 3)"
          fi

      - name: Setup Node.js
        if: steps.check_project.outputs.project_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check_project.outputs.project_exists == 'true'
        run: npm ci

      - name: Setup test environment
        if: steps.check_project.outputs.project_exists == 'true'
        run: |
          cp .env.example .env.test || echo "No .env.example found"
          echo "DATABASE_URL=postgresql://testuser:testpass@localhost:5432/trading_alerts_test" >> .env.test
          echo "NEXTAUTH_SECRET=test-secret-key-for-ci" >> .env.test
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env.test

      - name: Check for Prisma schema
        if: steps.check_project.outputs.project_exists == 'true'
        id: check_prisma
        run: |
          if [ -f "prisma/schema.prisma" ]; then
            echo "prisma_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Prisma schema found"
          else
            echo "prisma_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Prisma schema not found, skipping migrations"
          fi

      - name: Run database migrations
        if: steps.check_project.outputs.project_exists == 'true' && steps.check_prisma.outputs.prisma_exists == 'true'
        run: |
          npx prisma generate
          npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/trading_alerts_test

      - name: Build Next.js application
        if: steps.check_project.outputs.project_exists == 'true'
        run: npm run build

      - name: Start Next.js server
        if: steps.check_project.outputs.project_exists == 'true'
        run: |
          npm run start &
          echo $! > server.pid
          sleep 10
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/trading_alerts_test
          NEXTAUTH_SECRET: test-secret-key-for-ci
          NEXTAUTH_URL: http://localhost:3000

      - name: Wait for server to be ready
        if: steps.check_project.outputs.project_exists == 'true'
        run: |
          echo "â³ Waiting for Next.js server..."
          npx wait-on http://localhost:3000 --timeout 60000
          echo "âœ… Server is ready"

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Check for Postman collections
        if: steps.check_project.outputs.project_exists == 'true'
        id: check_collections
        run: |
          if [ -f "postman/trading-alerts-api.postman_collection.json" ]; then
            echo "collections_exist=true" >> $GITHUB_OUTPUT
            echo "âœ… Postman collections found"
          else
            echo "collections_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No Postman collections found yet (will be created in Phase 3)"
          fi

      - name: Run API tests with Newman
        if: steps.check_project.outputs.project_exists == 'true' && steps.check_collections.outputs.collections_exist == 'true'
        run: |
          echo "ðŸ§ª Running API integration tests..."
          newman run postman/trading-alerts-api.postman_collection.json \
            --environment postman/environment.json \
            --reporters cli,htmlextra \
            --reporter-htmlextra-export newman-report.html \
            --bail \
            --timeout-request 10000
          echo "âœ… API tests completed"
        continue-on-error: true

      - name: Upload test results
        if: steps.check_project.outputs.project_exists == 'true' && steps.check_collections.outputs.collections_exist == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: newman-test-results
          path: newman-report.html

      - name: Stop Next.js server
        if: always() && steps.check_project.outputs.project_exists == 'true'
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª API Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.check_project.outputs.project_exists }}" == "false" ]]; then
            echo "- â„¹ï¸ **Next.js project not created yet (Phase 1/2)**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“‹ This workflow will activate after Phase 3 when project is created" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Workflow configuration validated successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.check_collections.outputs.collections_exist }}" == "true" ]]; then
            echo "- âœ… Postman collections found and executed" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š Test report uploaded to artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ No Postman collections found (Phase 3 not started)" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸ Collections will be exported after Phase 3 Part 5" >> $GITHUB_STEP_SUMMARY
          fi
