name: Next.js CI (Progressive)

# Purpose: Progressive CI/CD for Next.js application
# Active: Activates incrementally as project is built during Phase 3
# Design: Checks for prerequisites before running each step

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  check-project-status:
    name: Check Project Readiness
    runs-on: ubuntu-latest
    outputs:
      has_config: ${{ steps.check.outputs.has_config }}
      has_typescript: ${{ steps.check.outputs.has_typescript }}
      has_app_dir: ${{ steps.check.outputs.has_app_dir }}
      has_tests: ${{ steps.check.outputs.has_tests }}
      project_phase: ${{ steps.check.outputs.project_phase }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check project configuration
        id: check
        run: |
          # Check for Next.js config
          if [ -f "next.config.js" ] || [ -f "next.config.mjs" ] || [ -f "next.config.ts" ]; then
            echo "has_config=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Next.js config found"
          else
            echo "has_config=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  Next.js config not found (expected in Phase 3)"
          fi

          # Check for TypeScript config
          if [ -f "tsconfig.json" ]; then
            echo "has_typescript=true" >> $GITHUB_OUTPUT
            echo "‚úÖ TypeScript config found"
          else
            echo "has_typescript=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  tsconfig.json not found (expected in Phase 3)"
          fi

          # Check for app directory with content
          if [ -d "app" ] && [ "$(find app -name '*.tsx' -o -name '*.ts' 2>/dev/null | wc -l)" -gt 2 ]; then
            echo "has_app_dir=true" >> $GITHUB_OUTPUT
            echo "‚úÖ app/ directory has substantial content"
          else
            echo "has_app_dir=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  app/ directory minimal (expected in Phase 1-2)"
          fi

          # Check for test files
          if [ "$(find . -name '*.test.ts' -o -name '*.test.tsx' -o -name '*.spec.ts' -o -name '*.spec.tsx' 2>/dev/null | grep -v node_modules | wc -l)" -gt 0 ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Test files found"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  No test files (expected in Phase 1-2)"
          fi

          # Determine project phase
          if [ -f "next.config.js" ] || [ -f "next.config.mjs" ] || [ -f "next.config.ts" ]; then
            echo "project_phase=phase3-or-later" >> $GITHUB_OUTPUT
            echo "üìç Project Phase: 3+ (Implementation)"
          else
            echo "project_phase=phase1-2" >> $GITHUB_OUTPUT
            echo "üìç Project Phase: 1-2 (Planning/Documentation)"
          fi

      - name: Display project status
        run: |
          echo "üìä Next.js Project Status"
          echo "========================"
          echo ""
          echo "Configuration:"
          echo "  Next.js config: ${{ steps.check.outputs.has_config }}"
          echo "  TypeScript config: ${{ steps.check.outputs.has_typescript }}"
          echo ""
          echo "Code:"
          echo "  app/ directory: ${{ steps.check.outputs.has_app_dir }}"
          echo "  Test files: ${{ steps.check.outputs.has_tests }}"
          echo ""
          echo "Phase: ${{ steps.check.outputs.project_phase }}"
          echo ""
          if [ "${{ steps.check.outputs.project_phase }}" == "phase1-2" ]; then
            echo "‚ÑπÔ∏è  Project is in planning phase - most CI steps will be skipped"
            echo "   This is expected and normal. CI will activate progressively during Phase 3."
          else
            echo "‚úÖ Project ready for CI/CD validation"
          fi

  install-and-build:
    name: Install Dependencies & Build
    runs-on: ubuntu-latest
    needs: check-project-status
    if: needs.check-project-status.outputs.has_config == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing npm dependencies..."
          npm ci

      - name: Build Next.js application
        run: |
          echo "üî® Building Next.js application..."
          npm run build
          echo "‚úÖ Build successful"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: .next/
          retention-days: 1

  type-check:
    name: TypeScript Type Checking
    runs-on: ubuntu-latest
    needs: check-project-status
    if: needs.check-project-status.outputs.has_typescript == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type checking
        run: |
          echo "üîç Running TypeScript type checking..."
          npm run type-check
          echo "‚úÖ Type checking passed"

  lint:
    name: Linting & Formatting
    runs-on: ubuntu-latest
    needs: check-project-status

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        continue-on-error: true
        run: |
          echo "üîç Running ESLint..."
          npm run lint || echo "‚ö†Ô∏è  Linting issues found (non-blocking during development)"

      - name: Check code formatting
        continue-on-error: true
        run: |
          echo "üîç Checking code formatting..."
          npm run format:check || echo "‚ö†Ô∏è  Formatting issues found (non-blocking during development)"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: check-project-status
    if: needs.check-project-status.outputs.has_tests == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          echo "üß™ Running tests..."
          npm test
          echo "‚úÖ Tests passed"
        env:
          CI: true

      - name: Upload test coverage
        if: always()
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [check-project-status, install-and-build, type-check, lint, test]
    if: always()

    steps:
      - name: Display CI summary
        run: |
          echo "üìä Next.js CI Summary"
          echo "===================="
          echo ""
          echo "Project Phase: ${{ needs.check-project-status.outputs.project_phase }}"
          echo ""
          echo "Jobs Executed:"
          echo "  check-project-status: ‚úÖ"
          echo "  install-and-build: ${{ needs.install-and-build.result || '‚è≠Ô∏è  skipped' }}"
          echo "  type-check: ${{ needs.type-check.result || '‚è≠Ô∏è  skipped' }}"
          echo "  lint: ${{ needs.lint.result || '‚è≠Ô∏è  skipped' }}"
          echo "  test: ${{ needs.test.result || '‚è≠Ô∏è  skipped' }}"
          echo ""
          if [ "${{ needs.check-project-status.outputs.project_phase }}" == "phase1-2" ]; then
            echo "‚ÑπÔ∏è  Most jobs skipped - this is expected during Phase 1-2"
            echo ""
            echo "üìù What this means:"
            echo "  - The repository is in planning/documentation phase"
            echo "  - CI/CD will progressively activate as you build the application"
            echo "  - When next.config.js and tsconfig.json are created, builds will run"
            echo "  - When test files are added, tests will run"
            echo ""
            echo "üöÄ Next steps:"
            echo "  - Continue with Phase 3 implementation using Aider"
            echo "  - CI will automatically detect new files and activate appropriate checks"
          else
            echo "‚úÖ Full CI/CD pipeline active"
            echo ""
            echo "All configured checks are running. Review any failures above."
          fi
