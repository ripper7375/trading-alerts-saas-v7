openapi: 3.0.3
info:
  title: Flask MT5 Microservice API
  version: 5.0.0
  description: |
    MT5 integration microservice for Trading Alerts SaaS platform.
    
    **Purpose:** Reads indicator data from centralized MT5 terminal with custom MQL5 indicators.
    
    **Architecture:**
    - Communicates with single MT5 terminal (your trading account)
    - Reads custom indicator buffers:
      - Fractal Horizontal Line_V5.mq5
      - Fractal Diagonal Line_V4.mq5
    
    **Tier-Based Access Control:**
    - FREE tier: XAUUSD only
    - PRO tier: 10 symbols (AUDUSD, BTCUSD, ETHUSD, EURUSD, GBPUSD, NDX100, US30, USDJPY, XAGUSD, XAUUSD)
    
    **Timeframes:** M15, M30, H1, H2, H4, H8, D1
    
    **Authentication:** API key via X-API-Key header (called by Next.js backend only)
  contact:
    name: MT5 Service Support
    email: support@tradingalerts.com
  license:
    name: Proprietary
    url: https://tradingalerts.com/license

servers:
  - url: http://localhost:5001
    description: Local development
  - url: http://mt5-service:5001
    description: Docker container (internal)
  - url: https://mt5.tradingalerts.com
    description: Production (internal - not public)

tags:
  - name: System
    description: Health checks and service status
  - name: Indicators
    description: Indicator data retrieval (tier-gated)
  - name: Metadata
    description: Symbols and timeframes information

security:
  - ApiKeyAuth: []

paths:
  # ============================================
  # SYSTEM ENDPOINTS
  # ============================================
  /api/health:
    get:
      tags:
        - System
      summary: Health check
      description: Check if MT5 service is running and connected to MT5 terminal
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                mt5_connected: true
                version: v5

  # ============================================
  # METADATA ENDPOINTS
  # ============================================
  /api/symbols:
    get:
      tags:
        - Metadata
      summary: Get accessible symbols by tier
      description: |
        Returns list of symbols accessible by the requesting tier.
        Tier is determined from X-User-Tier header.
      parameters:
        - $ref: '#/components/parameters/UserTierHeader'
      responses:
        '200':
          description: List of accessible symbols
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SymbolsResponse'
              examples:
                free_tier:
                  summary: FREE tier response
                  value:
                    success: true
                    tier: FREE
                    symbols:
                      - XAUUSD
                pro_tier:
                  summary: PRO tier response
                  value:
                    success: true
                    tier: PRO
                    symbols:
                      - AUDUSD
                      - BTCUSD
                      - ETHUSD
                      - EURUSD
                      - GBPUSD
                      - NDX100
                      - US30
                      - USDJPY
                      - XAGUSD
                      - XAUUSD
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/timeframes:
    get:
      tags:
        - Metadata
      summary: Get available timeframes
      description: Returns list of all supported timeframes (V5 - 7 timeframes)
      responses:
        '200':
          description: List of timeframes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TimeframesResponse'
              example:
                success: true
                timeframes:
                  - M15
                  - M30
                  - H1
                  - H2
                  - H4
                  - H8
                  - D1
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ============================================
  # INDICATORS ENDPOINT (MAIN)
  # ============================================
  /api/indicators/{symbol}/{timeframe}:
    get:
      tags:
        - Indicators
      summary: Get indicator data from MT5
      description: |
        Retrieves indicator data from custom MQL5 indicators running on centralized MT5 terminal.
        
        **Access Control:**
        - Validates tier access to symbol before reading data
        - FREE tier: XAUUSD only
        - PRO tier: All 10 symbols
        
        **Data Sources:**
        - OHLC: Direct from MT5 terminal
        - Horizontal lines: Fractal Horizontal Line_V5.mq5 (buffers 4-9)
        - Diagonal lines: Fractal Diagonal Line_V4.mq5 (buffers 0-5)
        - Fractals: Fractal Horizontal Line_V5.mq5 (buffers 0-1)
        
        **Requirements:**
        - Both indicators must be compiled and attached to chart in MT5
        - MT5 terminal must be running
        - Symbol must be available on broker
      parameters:
        - $ref: '#/components/parameters/SymbolPath'
        - $ref: '#/components/parameters/TimeframePath'
        - $ref: '#/components/parameters/BarsQuery'
        - $ref: '#/components/parameters/UserTierHeader'
      responses:
        '200':
          description: Indicator data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndicatorDataResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Symbol not accessible for tier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccessDeniedResponse'
              examples:
                free_tier_denied:
                  summary: FREE tier accessing PRO symbol
                  value:
                    success: false
                    error: FREE tier cannot access EURUSD
                    tier: FREE
                    accessible_symbols:
                      - XAUUSD
                    upgrade_required: true
        '500':
          description: MT5 error or indicator read failure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                indicator_not_attached:
                  summary: Indicator not found in MT5
                  value:
                    success: false
                    error: Failed to get handle for Fractal Horizontal Line_V5. Is the indicator attached to the chart in MT5?
                symbol_not_available:
                  summary: Symbol not available on broker
                  value:
                    success: false
                    error: Failed to select symbol BTCUSD
                invalid_timeframe:
                  summary: Invalid timeframe provided
                  value:
                    success: false
                    error: Invalid timeframe M5. Valid options M15, M30, H1, H2, H4, H8, D1

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key for authenticating requests from Next.js backend.
        This service should NOT be exposed publicly - only accessed by Next.js API routes.

  parameters:
    SymbolPath:
      name: symbol
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Symbol'
      description: Trading symbol
      example: XAUUSD

    TimeframePath:
      name: timeframe
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/Timeframe'
      description: Chart timeframe
      example: H1

    BarsQuery:
      name: bars
      in: query
      required: false
      schema:
        type: integer
        minimum: 100
        maximum: 5000
        default: 1000
      description: Number of historical bars to retrieve
      example: 1000

    UserTierHeader:
      name: X-User-Tier
      in: header
      required: false
      schema:
        $ref: '#/components/schemas/UserTier'
      description: |
        User tier from Next.js session. Used for access control validation.
        Defaults to FREE if not provided.
      example: PRO

  schemas:
    # ============================================
    # ENUMS
    # ============================================
    UserTier:
      type: string
      enum:
        - FREE
        - PRO
      description: |
        User subscription tier for access control:
        - FREE: XAUUSD only
        - PRO: All 10 symbols

    Symbol:
      type: string
      enum:
        - AUDUSD
        - BTCUSD
        - ETHUSD
        - EURUSD
        - GBPUSD
        - NDX100
        - US30
        - USDJPY
        - XAGUSD
        - XAUUSD
      description: |
        Trading symbols available on platform.
        Access is tier-based:
        - FREE: XAUUSD
        - PRO: All symbols

    Timeframe:
      type: string
      enum:
        - M15
        - M30
        - H1
        - H2
        - H4
        - H8
        - D1
      description: |
        Chart timeframes (V5 - 7 timeframes).
        Removed: M1, M5
        Added: H2, H8

    # ============================================
    # RESPONSE SCHEMAS
    # ============================================
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum:
            - ok
            - error
          description: Overall service status
        mt5_connected:
          type: boolean
          description: Whether MT5 terminal is connected
        version:
          type: string
          description: Service version identifier
          example: v5
      required:
        - status
        - mt5_connected
        - version

    SymbolsResponse:
      type: object
      properties:
        success:
          type: boolean
        tier:
          $ref: '#/components/schemas/UserTier'
        symbols:
          type: array
          items:
            $ref: '#/components/schemas/Symbol'
          description: List of symbols accessible by tier
      required:
        - success
        - tier
        - symbols

    TimeframesResponse:
      type: object
      properties:
        success:
          type: boolean
        timeframes:
          type: array
          items:
            $ref: '#/components/schemas/Timeframe'
          description: List of all supported timeframes
      required:
        - success
        - timeframes

    IndicatorDataResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/IndicatorData'
      required:
        - success
        - data

    IndicatorData:
      type: object
      description: Complete indicator data package from MT5
      properties:
        ohlc:
          type: array
          items:
            $ref: '#/components/schemas/OHLCBar'
          description: OHLC candlestick data
        horizontal:
          $ref: '#/components/schemas/HorizontalLines'
        diagonal:
          $ref: '#/components/schemas/DiagonalLines'
        fractals:
          $ref: '#/components/schemas/Fractals'
        metadata:
          $ref: '#/components/schemas/IndicatorMetadata'
      required:
        - ohlc
        - horizontal
        - diagonal
        - fractals
        - metadata

    OHLCBar:
      type: object
      description: Single candlestick bar
      properties:
        time:
          type: integer
          description: Unix timestamp
          example: 1699632000
        open:
          type: number
          format: double
          description: Opening price
          example: 1985.50
        high:
          type: number
          format: double
          description: Highest price
          example: 1987.25
        low:
          type: number
          format: double
          description: Lowest price
          example: 1984.75
        close:
          type: number
          format: double
          description: Closing price
          example: 1986.00
        volume:
          type: integer
          description: Tick volume
          example: 1234
      required:
        - time
        - open
        - high
        - low
        - close
        - volume

    HorizontalLines:
      type: object
      description: |
        Horizontal support/resistance lines from Fractal Horizontal Line_V5.mq5.
        Read from indicator buffers 4-9.
      properties:
        peak_1:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: First peak line (buffer 4)
        peak_2:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Second peak line (buffer 5)
        peak_3:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Third peak line (buffer 6)
        bottom_1:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: First bottom line (buffer 7)
        bottom_2:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Second bottom line (buffer 8)
        bottom_3:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Third bottom line (buffer 9)
      required:
        - peak_1
        - peak_2
        - peak_3
        - bottom_1
        - bottom_2
        - bottom_3

    DiagonalLines:
      type: object
      description: |
        Diagonal trend lines from Fractal Diagonal Line_V4.mq5.
        Read from indicator buffers 0-5.
      properties:
        ascending_1:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: First ascending trend line (buffer 0)
        ascending_2:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Second ascending trend line (buffer 1)
        ascending_3:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Third ascending trend line (buffer 2)
        descending_1:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: First descending trend line (buffer 3)
        descending_2:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Second descending trend line (buffer 4)
        descending_3:
          type: array
          items:
            $ref: '#/components/schemas/LinePoint'
          description: Third descending trend line (buffer 5)
      required:
        - ascending_1
        - ascending_2
        - ascending_3
        - descending_1
        - descending_2
        - descending_3

    LinePoint:
      type: object
      description: Single point on a line (filtered EMPTY_VALUE)
      properties:
        index:
          type: integer
          description: Bar index (0 = most recent)
          example: 15
        value:
          type: number
          format: double
          description: Price level at this point
          example: 1985.50
      required:
        - index
        - value

    Fractals:
      type: object
      description: |
        Fractal markers from Fractal Horizontal Line_V5.mq5.
        Peaks from buffer 0, bottoms from buffer 1.
      properties:
        peaks:
          type: array
          items:
            $ref: '#/components/schemas/FractalPoint'
          description: Upper fractals (resistance points)
        bottoms:
          type: array
          items:
            $ref: '#/components/schemas/FractalPoint'
          description: Lower fractals (support points)
      required:
        - peaks
        - bottoms

    FractalPoint:
      type: object
      description: Single fractal marker
      properties:
        time:
          type: integer
          description: Unix timestamp of fractal
          example: 1699632000
        price:
          type: number
          format: double
          description: Price level of fractal
          example: 1987.50
      required:
        - time
        - price

    IndicatorMetadata:
      type: object
      description: Metadata about the indicator data
      properties:
        symbol:
          $ref: '#/components/schemas/Symbol'
        timeframe:
          $ref: '#/components/schemas/Timeframe'
        tier:
          $ref: '#/components/schemas/UserTier'
        bars_returned:
          type: integer
          description: Actual number of bars returned
          example: 1000
      required:
        - symbol
        - timeframe
        - tier
        - bars_returned

    # ============================================
    # ERROR SCHEMAS
    # ============================================
    AccessDeniedResponse:
      type: object
      description: Returned when tier cannot access requested symbol
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Human-readable error message
          example: FREE tier cannot access EURUSD
        tier:
          $ref: '#/components/schemas/UserTier'
        accessible_symbols:
          type: array
          items:
            type: string
          description: List of symbols accessible by this tier
        upgrade_required:
          type: boolean
          description: Whether upgrade to PRO is needed
      required:
        - success
        - error
        - tier
        - accessible_symbols
        - upgrade_required

    ErrorResponse:
      type: object
      description: Generic error response
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error message
          example: Failed to get handle for indicator
      required:
        - success
        - error

  responses:
    Unauthorized:
      description: Invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: Unauthorized

  # ============================================
  # EXAMPLES
  # ============================================
  examples:
    CompleteIndicatorData:
      summary: Complete indicator data response
      description: Full example of indicator data from XAUUSD H1
      value:
        success: true
        data:
          ohlc:
            - time: 1699632000
              open: 1985.50
              high: 1987.25
              low: 1984.75
              close: 1986.00
              volume: 1234
            - time: 1699628400
              open: 1984.25
              high: 1986.00
              low: 1983.50
              close: 1985.50
              volume: 1156
          horizontal:
            peak_1:
              - index: 10
                value: 1987.50
              - index: 11
                value: 1987.50
            peak_2:
              - index: 5
                value: 1989.25
            peak_3: []
            bottom_1:
              - index: 15
                value: 1983.00
            bottom_2:
              - index: 20
                value: 1981.50
            bottom_3: []
          diagonal:
            ascending_1:
              - index: 0
                value: 1986.00
              - index: 1
                value: 1985.75
              - index: 2
                value: 1985.50
            ascending_2: []
            ascending_3: []
            descending_1:
              - index: 0
                value: 1986.00
              - index: 1
                value: 1986.25
              - index: 2
                value: 1986.50
            descending_2: []
            descending_3: []
          fractals:
            peaks:
              - time: 1699632000
                price: 1987.50
              - time: 1699614000
                price: 1989.25
            bottoms:
              - time: 1699625200
                price: 1983.00
              - time: 1699610400
                price: 1981.50
          metadata:
            symbol: XAUUSD
            timeframe: H1
            tier: FREE
            bars_returned: 1000