# Testing Framework Compliance Policy

**Policy Number:** 09
**Version:** 1.0
**Last Updated:** November 26, 2025
**Purpose:** Ensure all generated code complies with ESLint, Jest, and TypeScript standards to pass CI/CD on first attempt

---

## Overview

This policy defines MANDATORY requirements for code quality, testing compatibility, and framework compliance. All code generated by Aider MUST pass these checks before being committed.

**Key Principle:** If it will fail in CI/CD, it must be prevented during generation.

---

## ESLint Standards (MANDATORY)

### Critical Rules (Zero Tolerance)

| Rule                      | Requirement                                   | Example                                                        | Rationale                                  |
| ------------------------- | --------------------------------------------- | -------------------------------------------------------------- | ------------------------------------------ |
| **Explicit Return Types** | ALL functions must have explicit return types | `function getData(): Promise<Data>`                            | TypeScript safety, prevents implicit any   |
| **No `any` Types**        | FORBIDDEN - use proper TypeScript types       | Use `unknown` then type guard, or define interfaces            | Type safety, prevents runtime errors       |
| **No Console Statements** | Remove all console.log/warn (except error)    | Use conditional: `if (process.env.NODE_ENV === 'development')` | Clean production code, no debug statements |

### Configuration Reference

**Source:** `.eslintrc.json`

```typescript
// These rules WILL BLOCK your PR:
{
  "@typescript-eslint/explicit-function-return-type": "warn",
  "@typescript-eslint/no-explicit-any": "error",
  "no-console": ["warn", { "allow": ["warn", "error"] }]
}
```

### Examples

#### ✅ CORRECT - Will Pass ESLint

```typescript
/**
 * Fetches user data from the database
 * @param userId - User ID to fetch
 * @returns Promise resolving to user object
 */
export async function getUser(userId: string): Promise<User> {
  try {
    const user = await prisma.user.findUnique({
      where: { id: userId },
    });

    if (!user) {
      throw new Error('User not found');
    }

    return user;
  } catch (error) {
    console.error('Failed to fetch user:', error); // ✅ error is allowed
    throw error;
  }
}
```

#### ❌ INCORRECT - Will Fail ESLint

```typescript
// ❌ No return type
export async function getUser(userId: string) {
  try {
    // ❌ Using 'any' type
    const user: any = await prisma.user.findUnique({
      where: { id: userId },
    });

    console.log('Fetching user:', userId); // ❌ console.log not allowed

    return user;
  } catch (error) {
    console.log('Error:', error); // ❌ console.log not allowed
    throw error;
  }
}
```

---

## Jest Requirements (MANDATORY)

### Package Naming Convention

| Requirement              | Implementation                                                 | Validation                               |
| ------------------------ | -------------------------------------------------------------- | ---------------------------------------- |
| **Unique Package Names** | Each `package.json` must have a unique name based on directory | No "my-v0-project" or duplicate names    |
| **Naming Pattern**       | Use kebab-case matching directory name                         | `alert-card-component`, not `my-project` |
| **Haste Map**            | Jest Haste Map requires unique module names                    | Run `npm test` to verify no collisions   |

### Test File Structure

| Requirement          | Implementation                           | Example                                |
| -------------------- | ---------------------------------------- | -------------------------------------- |
| **Co-located Tests** | Place `.test.tsx` alongside component    | `AlertCard.tsx` → `AlertCard.test.tsx` |
| **Test Naming**      | Follow pattern: `ComponentName.test.tsx` | `UserProfile.test.tsx`                 |
| **Test Coverage**    | Write testable, modular code             | Functions should be < 50 lines         |

### Coverage Thresholds

**Source:** `jest.config.js`

```javascript
coverageThreshold: {
  global: {
    branches: 50,
    functions: 60,
    lines: 45,
    statements: 45,
  },
}
```

**Note:** Current thresholds are temporarily lowered (from 60%). Write code that achieves >60% coverage for future-proofing.

### Examples

#### ✅ CORRECT - Unique Package Name

```json
// seed-code/v0-components/alert-card-component/package.json
{
  "name": "alert-card-component", // ✅ Unique, matches directory
  "version": "0.1.0",
  "private": true
}
```

#### ❌ INCORRECT - Duplicate Package Name

```json
// seed-code/v0-components/alerts-management-page/package.json
{
  "name": "my-v0-project", // ❌ Generic name, will cause Haste Map collision
  "version": "0.1.0",
  "private": true
}
```

---

## TypeScript Standards (MANDATORY)

### Strict Mode Compliance

**Source:** `tsconfig.json`

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true
  }
}
```

### Type Definition Requirements

| Category                | Requirement                          | Example                                        |
| ----------------------- | ------------------------------------ | ---------------------------------------------- |
| **Function Parameters** | All parameters must have types       | `function foo(id: string)`                     |
| **Function Returns**    | All functions must have return types | `function foo(): Promise<User>`                |
| **Object Types**        | Use interfaces or types, not inline  | `interface User { id: string; name: string; }` |
| **Array Types**         | Specify element type                 | `items: string[]` not `items: any[]`           |
| **Null Safety**         | Handle null/undefined explicitly     | Use `user?.name` or null checks                |

### Import Standards

```typescript
// ✅ CORRECT - Typed imports
import type { User } from '@/types/user';
import { prisma } from '@/lib/db/prisma';

// ❌ INCORRECT - Untyped or implicit
const prisma = require('@/lib/db/prisma'); // No TypeScript
```

---

## Aider Pre-Generation Checklist

Before generating code for ANY component, API route, or utility:

- [ ] **Review `.eslintrc.json`** - What rules are enforced?
- [ ] **Review `jest.config.js`** - What are coverage thresholds?
- [ ] **Check existing package names** - Is the new package name unique?
- [ ] **Plan function signatures** - What are parameter and return types?
- [ ] **Identify interfaces needed** - What TypeScript types are required?
- [ ] **Consider testability** - Can this code be easily tested?
- [ ] **Verify no console statements** - Are there any console.log to remove?

---

## Common Violations and Fixes

### Violation 1: Missing Return Type

```typescript
// ❌ BEFORE
export async function createAlert(data) {
  return await prisma.alert.create({ data });
}

// ✅ AFTER
export async function createAlert(data: CreateAlertInput): Promise<Alert> {
  return await prisma.alert.create({ data });
}
```

### Violation 2: Using `any` Type

```typescript
// ❌ BEFORE
const results: any = {
  admin: null,
  alerts: [],
};

// ✅ AFTER
interface SeedResults {
  admin: User | null;
  alerts: Alert[];
}

const results: SeedResults = {
  admin: null,
  alerts: [],
};
```

### Violation 3: Console Statements

```typescript
// ❌ BEFORE
export async function processData() {
  console.log('Processing started');
  const data = await fetch();
  console.log('Data:', data);
  return data;
}

// ✅ AFTER
export async function processData(): Promise<Data> {
  // Remove console.log - use logger if needed
  const data = await fetch();
  return data;
}
```

### Violation 4: Duplicate Package Names

```bash
# ❌ BEFORE - All have "my-v0-project"
grep -r '"name": "my-v0-project"' seed-code/v0-components/*/package.json
# Returns: 20 files (Haste Map collision!)

# ✅ AFTER - Each has unique name
seed-code/v0-components/alert-card-component/package.json: "name": "alert-card-component"
seed-code/v0-components/pricing-page-component-v3/package.json: "name": "pricing-page-component-v3"
```

---

## Validation Commands

Run these commands to verify compliance BEFORE committing:

```bash
# 1. Check TypeScript types
npm run type-check
# Expected: "No errors found"

# 2. Check ESLint
npm run lint
# Expected: "0 errors, 0 warnings"

# 3. Run tests
npm test
# Expected: "All tests passed, coverage >45%"

# 4. Check for console statements
grep -r "console\\.log" app/ lib/ components/
# Expected: "No results" (or only in dev utilities)

# 5. Check for 'any' types
grep -r ": any" app/ lib/ components/
# Expected: "No results"
```

---

## Integration with CI/CD

### Three-Layer Protection

**Layer 1: Generation Time (Aider)**

- Aider reads this policy → generates compliant code
- **Catches: 90% of issues**

**Layer 2: Pre-Commit Hook (Local)**

- ESLint + Prettier run automatically
- Takes 5-10 seconds
- **Catches: 9% of issues**

**Layer 3: GitHub Actions (CI/CD)**

- Track 1 (Development CI): Comprehensive feedback
- Track 2 (`tests.yml`): BLOCKS deployment
- **Catches: 1% of issues**

### CI/CD Failure Prevention

If you follow this policy:

- ✅ ESLint will pass on first run
- ✅ Jest will pass on first run
- ✅ TypeScript will compile without errors
- ✅ PR will merge without blocking issues
- ✅ Zero rework cycles needed

---

## Policy Maintenance

**Review Triggers:**

- When `.eslintrc.json` rules change
- When `jest.config.js` thresholds change
- When `tsconfig.json` compiler options change
- After any CI/CD pipeline update

**Update Process:**

1. Detect configuration change
2. Update this policy within 24 hours
3. Notify team of policy update
4. Verify Aider can read new rules

---

## References

**Internal:**

- `docs/policies/05-coding-patterns.md` - Code quality patterns
- `docs/policies/06-aider-instructions.md` - Aider workflow
- `docs/principles/shift-left-testing.md` - Shift-left methodology
- `.eslintrc.json` - ESLint configuration (READ THIS)
- `jest.config.js` - Jest configuration (READ THIS)
- `tsconfig.json` - TypeScript configuration (READ THIS)

**External:**

- [ESLint Rules](https://eslint.org/docs/latest/rules/)
- [Jest Configuration](https://jestjs.io/docs/configuration)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/handbook/intro.html)

---

**Policy Status:** Active
**Enforcement:** CI/CD Blocking
**Last Reviewed:** November 26, 2025
